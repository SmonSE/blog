---
layout: post
title: ESP8266 - Gaszähler auslesen
date: 2022-02-09 17:20:29.000000000 +01:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Blog
- HomeAssistant
tags:
- 3D Printer
- ESP8266
- G4 RF1
- Gaszähler
- KY-025
- Magnetschalter
- Reed Sensor
- Tinkercad
- WeMosD1
- WeMosD1 Mini Pro
meta:
  rank_math_seo_score: '83'
  _edit_last: '1'
  _ez-toc-disabled: ''
  _ez-toc-insert: ''
  _ez-toc-heading-levels: a:1:{i:2;i:2;}
  _ez-toc-alttext: ''
  _ez-toc-exclude: ''
  rank_math_internal_links_processed: '1'
  rank_math_focus_keyword: ESP8266
  rank_math_primary_category: '13'
  rank_math_og_content_image: a:2:{s:5:"check";s:32:"0221bc8a2bb65e94c75aab51ccc76176";s:6:"images";a:1:{i:0;i:903;}}
author:
  login: smon
  email: simon_eisele@web.de
  display_name: Simon Eisele
  first_name: Simon
  last_name: Eisele
permalink: "/2022/02/09/esp8266-gaszahler-auslesen/"
---
<p><!-- wp:paragraph --></p>
<p>Mit der Hilfe eines ESP8266 und eines Magnetschalters ( Reed Sensor ) kann am Gaszähler ( G4 RF1) über den Internen Magneten der aktuelle Verbrauch abgelesen werden ( 1 Imp = 0.1m³ ). Eingebunden ist das ganze wie bereits beim <a href="https://affengriff.net/2021/10/26/esp8266-stromzahler-auslesen/" target="_blank" rel="noreferrer noopener">digitalen Stromzähler</a> in Home Assistant ( HASSIO ). Dort kann man sich die Verbrauchswerte für die unterschiedliche Zeiten (Tag, Woche, Monat, Jahr) anzeigen lassen. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Mein erstes Problem bestand darin das ich mittels eines normalen WeMos D1 keinen Empfang im Heizraum hatte. Daraufhin habe ich den WeMos D1 Mini Pro mittels externer Antenne ausprobiert, mit Erfolg. Die Signalstärke ist ausreichend um die Daten über Wlan zu senden.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><strong>NEUE LÖSUNG MIT <a href="https://affengriff.net/2022/09/29/gaszahler-auslesen/" target="_blank" rel="noreferrer noopener">AQARA TÜR FENSTERSENSOR</a></strong></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2 id="benotigte-hardware"><strong>Benötigte Hardware</strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:list --></p>
<ul>
<li><a href="https://www.amazon.de/AZDelivery-ESP8266-ESP-8266EX-Entwicklung-inklusive/dp/B08BTXCZC1/ref=sr_1_2_sspa?__mk_de_DE=ÅMÅŽÕÑ&amp;crid=3P4D055YFXIAG&amp;keywords=Memos%2Bd1%2Bmini&amp;qid=1644400539&amp;sprefix=memos%2Bd1%2Bmini%2Caps%2C82&amp;sr=8-2-spons&amp;smid=A1X7QLRQH87QA3&amp;spLa=ZW5jcnlwdGVkUXVhbGlmaWVyPUE3TFNNMVJCU0tDMzQmZW5jcnlwdGVkSWQ9QTAwNTk4ODQxRzc2UkIzQ1NVR002JmVuY3J5cHRlZEFkSWQ9QTA2NzY4MjIxM0tSRFZaTEFVNVdUJndpZGdldE5hbWU9c3BfYXRmJmFjdGlvbj1jbGlja1JlZGlyZWN0JmRvTm90TG9nQ2xpY2s9dHJ1ZQ&amp;th=1" target="_blank" rel="noreferrer noopener">ESP8266</a>&nbsp;( WeMos D1 Mini Pro )</li>
<li><a href="https://www.amazon.de/AZDelivery-KY-025-Magnetschalter-Sensor-gratis/dp/B089QJVBL7/ref=sr_1_1_sspa?__mk_de_DE=ÅMÅŽÕÑ&amp;crid=8L95OBHAHWKM&amp;keywords=reed%2Bsensor&amp;qid=1644836930&amp;sprefix=reed%2Bsensor%2Caps%2C76&amp;sr=8-1-spons&amp;spLa=ZW5jcnlwdGVkUXVhbGlmaWVyPUEzUDhBV0xVQVoxVlhRJmVuY3J5cHRlZElkPUEwNTQ2MTc4MzhWT0UxWlJHTjdCTSZlbmNyeXB0ZWRBZElkPUEwNTIxMDg0MjRDNkdMWjRGNEIzNCZ3aWRnZXROYW1lPXNwX2F0ZiZhY3Rpb249Y2xpY2tSZWRpcmVjdCZkb05vdExvZ0NsaWNrPXRydWU&amp;th=1" target="_blank" rel="noreferrer noopener">Reed Sensor&nbsp;</a>( KY-025 )</li>
<li>Einzeladern</li>
<li><a href="https://affengriff.net/category/3d-prints/" target="_blank" rel="noreferrer noopener">3D Drucker&nbsp;</a></li>
<li>Gaszähler G4 RF1</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:heading --></p>
<h2 id="benotigte-software"><strong>Benötigte Software</strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:list --></p>
<ul>
<li><a href="https://www.tinkercad.com" target="_blank" rel="noreferrer noopener">TinkerCad</a></li>
<li><a href="https://www.prusa3d.de" target="_blank" rel="noreferrer noopener">PrusaSlicer</a></li>
<li><a href="https://www.home-assistant.io/getting-started/" target="_blank" rel="noreferrer noopener">Home Assistant</a></li>
<li><a href="https://esphome.io" target="_blank" rel="noreferrer noopener">ESP Home</a></li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:heading --></p>
<h2 id="3d-gehause-tinkercad"><strong>3D Gehäuse Tinkercad</strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:list --></p>
<ul>
<li><a href="https://www.tinkercad.com/things/gjmYXJnO9qC" target="_blank" rel="noreferrer noopener">Gaszähler G4 RF1</a></li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:heading --></p>
<h2 id="aufbau"><strong>Aufbau</strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:gallery {"linkTo":"none"} --></p>
<figure class="wp-block-gallery has-nested-images columns-default is-cropped"><!-- wp:image {"id":903,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image size-large"><img src="{{ site.baseurl }}/assets/2022/02/Bildschirmfoto-2022-02-09-um-11.07.32.png" alt="" class="wp-image-903" /></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:image {"id":905,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image size-large"><img src="{{ site.baseurl }}/assets/2022/02/Bildschirmfoto-2022-02-09-um-11.23.15-730x1024.png" alt="" class="wp-image-905" /></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:image {"id":906,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image size-large"><img src="{{ site.baseurl }}/assets/2022/02/IMG_9647-732x1024.jpg" alt="" class="wp-image-906" /></figure>
<p><!-- /wp:image --></figure>
<p><!-- /wp:gallery --></p>
<p><!-- wp:paragraph --></p>
<p>In meinem Fall habe ich mir bei Thingiverse ein passendes Case für den WeMos D1 Mini Pro geholt und mittels Tinkercad auf mein entworfenes Case gesetzt. Somit kann jede beliebige ESP8266 Platine mit der Magnetsensor Grundplatte verbunden werden. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2 id="ky-025-magnetschalter-anschlussplan"><strong>KY-025 Magnetschalter Anschlussplan</strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Beim Magnetschalter muss man sehr auf das Glasröhrchen achten. Ich habe das Glasröhrchen mit dem Reed Kontakt leicht nach unten gebogen damit es bündig mit dem Auslass am gedruckten Gehäuse abschließt. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li>WeMos 5V ----&gt; + KY-025</li>
<li>WeMos GND --&gt; - KY-025</li>
<li>WeMos D5 ----&gt; A0 KY-025</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:heading --></p>
<h2 id="gaszahler-typ-g4-rf1"><strong>Gaszähler </strong>Typ <strong>G4 RF1</strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:media-text {"mediaId":923,"mediaLink":"https://affengriff.net/?attachment_id=923#main","mediaType":"image","mediaWidth":39} --></p>
<div class="wp-block-media-text alignwide is-stacked-on-mobile" style="grid-template-columns:39% auto">
<figure class="wp-block-media-text__media"><img src="{{ site.baseurl }}/assets/2022/02/IMG_9661-716x1024.jpg" alt="G4 RF1 von Actaris ESP8266" class="wp-image-923 size-full" /></figure>
<div class="wp-block-media-text__content"><!-- wp:paragraph --></p>
<p>Bei meinem Gaszähler handelt es sich um das Model G4 RF1 von Actaris. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Das Model G4 RF1 von Pipersberg ist baugleich soweit ich weiß. Daher sollte das Case für den Sensor auch hier passen.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></div>
</div>
<p><!-- /wp:media-text --></p>
<p><!-- wp:heading --></p>
<h2 id="esp-home-sensor-config-yaml"><strong><strong>ESP Home Sensor config.yaml</strong></strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Hier hatte ich zu Beginn Probleme beim Kompilieren der Software. Ich hatte unter board den d1_mini_pro stehen welcher normal über 16MB Speicher verfügt. Bei meiner Bestellung habe ich übersehen das mein WeMos D1 Mini Pro mit nur 4 MB bestückt ist. Daher musste ich die Software für einen normalen d1_mini kompilieren. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:code --></p>
<pre class="wp-block-code"><code lang="yaml" class="language-yaml">esphome:
  name: gas

# d1 mini pro but only with 4MB -&gt; d1_mini
esp8266:
  board: d1_mini 

sensor:
  - platform: pulse_counter
    pin: 
      number: D5
      mode: INPUT_PULLUP
    name: "Gasverbrauch"
    state_class: total_increasing
    device_class: gas
    update_interval : 60s
    filters:
      - lambda: |-
          static float total_value = 0.0;
          total_value += x * 0.1;
          return total_value;
    unit_of_measurement: "m³"
    accuracy_decimals: 2
    icon: 'mdi:fire' 
    id: gasverbrauch

time:
  - platform: sntp
    id: my_time    

# Enable logging
logger:

# Enable Home Assistant API
api:

ota:
  password: "xxxxxxxxxxxxxxxxxxxxxxxxxx"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Gas Fallback Hotspot"
    password: "xxxxxxxxxxxx"

captive_portal:
</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:heading --></p>
<h2 id="hassio-config-configuration-yaml"><strong>Hassio /config/configuration.yaml</strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:code --></p>
<pre class="wp-block-code"><code lang="yaml" class="language-yaml">......

utility_meter:
  gasverbrauch_daily:
    source: sensor.gasverbrauch
    cycle: daily
  gasverbrauch_weekly:  
    source: sensor.gasverbrauch
    cycle: weekly
  gasverbrauch_monthly:
    source: sensor.gasverbrauch
    cycle: monthly
  gasverbrauch_yearly:
    source: sensor.gasverbrauch
    cycle: yearly 

......</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:heading --></p>
<h2 id="home-assistant-grafische-darstellung"><strong><strong>Home Assistant grafische Darstellung</strong></strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:gallery {"linkTo":"none"} --></p>
<figure class="wp-block-gallery has-nested-images columns-default is-cropped"><!-- wp:image {"id":913,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image size-large"><img src="{{ site.baseurl }}/assets/2022/02/IMG_9654-613x1024.jpg" alt="" class="wp-image-913" /></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:image {"id":912,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image size-large"><img src="{{ site.baseurl }}/assets/2022/02/IMG_9656-609x1024.jpg" alt="" class="wp-image-912" /></figure>
<p><!-- /wp:image --></figure>
<p><!-- /wp:gallery --></p>

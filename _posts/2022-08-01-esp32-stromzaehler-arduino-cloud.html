---
layout: post
title: ESP32 - Digitaler Stromzähler auslesen Arduino IoT Cloud Remote
date: 2022-08-01 15:05:42.000000000 +02:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Blog
- Projekte
tags:
- 3D Drucker
- Arduino IoT Cloud
- Digitaler Stromzaehler
- ESP32
- IoT
- Remote App
meta:
  rank_math_internal_links_processed: '1'
  rank_math_seo_score: '85'
  _edit_last: '1'
  _ez-toc-disabled: ''
  _ez-toc-insert: ''
  _ez-toc-heading-levels: a:0:{}
  _ez-toc-alttext: ''
  _ez-toc-exclude: ''
  _oembed_c2944b252fab8fc4cbd1dfa6bcd805e1: "{{unknown}}"
  _oembed_a7d0bdae739bf6a84521cf87523b0ead: "{{unknown}}"
  rank_math_primary_category: '13'
  rank_math_focus_keyword: ESP32
  _oembed_1b68f80cd12669094a9477695d93a4af: "{{unknown}}"
  rank_math_og_content_image: a:2:{s:5:"check";s:32:"a1de4c41dae7e5382d474caada11175e";s:6:"images";a:1:{i:0;i:1082;}}
author:
permalink: "/2022/08/01/esp32-stromzaehler-arduino-cloud/"
---
<p><!-- wp:paragraph --></p>
<p>Mit der Hilfe eines ESP32 und eines einfachen IR Moduls kann am Stromzähler der aktuelle Stromverbrauch ausgelesen werden <strong>ohne</strong> das man den Stromzähler PIN benötigt. Auf der Suche nach einer Alternative zu der doch komplizierten <a href="https://affengriff.net/2022/04/08/esp32-stromzahler-auslesen-webserver/" target="_blank" rel="noreferrer noopener">WebServer Lösung</a> bin ich auf die Arduino IoT Cloud <a href="https://docs.arduino.cc/arduino-cloud/" target="_blank" rel="noreferrer noopener">Seite</a> gestoßen. Nach kürzester Zeit hatte ich die Daten meines ESP32 + IR Moduls auf dem Handy Bildschirm.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2><strong>Arduino IoT Cloud Remote App</strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:image {"id":1082,"width":481,"height":602,"sizeSlug":"full","linkDestination":"none"} --></p>
<figure class="wp-block-image size-full is-resized"><img src="{{ site.baseurl }}/assets/2022/08/IMG_0842.jpg" alt="Arduino IoT Remote App " class="wp-image-1082" width="481" height="602" /><br />
<figcaption>Die Werte sind so niedrig da mein Solarkraftwerk zu dem Zeitpunkt Strom generiert hat.</figcaption>
</figure>
<p><!-- /wp:image --></p>
<p><!-- wp:heading --></p>
<h2><strong>Benötigte Hardware</strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:list --></p>
<ul>
<li>ESP32-WROOM-32 D1 mini (AZ-Delivery)</li>
<li><a href="https://www.amazon.de/AZDelivery-TRCT5000-Infrarot-Hindernis-Vermeidung/dp/B07DRCKV3X/ref=sr_1_2_sspa?__mk_de_DE=ÅMÅŽÕÑ&amp;dchild=1&amp;keywords=TCRT5000&amp;qid=1635199629&amp;sr=8-2-spons&amp;psc=1&amp;smid=A1X7QLRQH87QA3&amp;spLa=ZW5jcnlwdGVkUXVhbGlmaWVyPUFQTFpMMFZCM0wyV1AmZW5jcnlwdGVkSWQ9QTAxMDUwNjMxOU1NMlZLVllIUU9FJmVuY3J5cHRlZEFkSWQ9QTA5Njk5MjFKNERJWDlPNUxENk8md2lkZ2V0TmFtZT1zcF9hdGYmYWN0aW9uPWNsaWNrUmVkaXJlY3QmZG9Ob3RMb2dDbGljaz10cnVl" target="_blank" rel="noreferrer noopener">IR Modul</a>&nbsp;(TCRT5000)&nbsp;</li>
<li>3D Drucker + Filament</li>
<li>Lötstation mit Equipment</li>
<li>Einzeladern</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:heading --></p>
<h2><strong>Benötigte Software</strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:list --></p>
<ul>
<li><a href="https://www.tinkercad.com" target="_blank" rel="noreferrer noopener">TinkerCad</a></li>
<li><a href="https://www.prusa3d.de" target="_blank" rel="noreferrer noopener">PrusaSlicer</a></li>
<li>Arduino IoT Cloud</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:heading --></p>
<h2><strong>Aufbau Gehäuse</strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:gallery {"linkTo":"none"} --></p>
<figure class="wp-block-gallery has-nested-images columns-default is-cropped"><!-- wp:image {"id":1019,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image size-large"><img src="{{ site.baseurl }}/assets/2022/08/Bildschirmfoto-2022-04-07-um-08.52.16.png" alt="" class="wp-image-1019" /></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:image {"id":1020,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image size-large"><img src="{{ site.baseurl }}/assets/2022/08/Bildschirmfoto-2022-04-07-um-08.52.41.png" alt="" class="wp-image-1020" /></figure>
<p><!-- /wp:image --></figure>
<p><!-- /wp:gallery --></p>
<p><!-- wp:paragraph --></p>
<p>Das neue Zählergehäuse findet man&nbsp;<a href="https://www.tinkercad.com/things/gfMDpMCaC8Z" target="_blank" rel="noreferrer noopener">hier</a>.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2><strong>IR Modul TCRT5000 modifikation</strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:media-text {"mediaId":771,"mediaLink":"https://affengriff.net/2021/10/26/esp8266-stromzahler-auslesen/bildschirmfoto-2022-01-07-um-21-30-02/","mediaType":"image","mediaWidth":24} --></p>
<div class="wp-block-media-text alignwide is-stacked-on-mobile" style="grid-template-columns:24% auto">
<figure class="wp-block-media-text__media"><img src="{{ site.baseurl }}/assets/2022/08/Bildschirmfoto-2022-01-07-um-21.30.02-610x1024.png" alt="" class="wp-image-771 size-full" /></figure>
<div class="wp-block-media-text__content"><!-- wp:paragraph --></p>
<p>Auf dem TCRT5000 befindet sich eine Lesediode und eine Schreibdiode. Die Schreibdiode wird auch als Näherungssensor verwendet wodurch es zu Problemen kommen kann beim Ablesen des Stromzählers.&nbsp;</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>In meinem Fall habe ich die hellere (weiße Diode) einfach ausgelötet. In anderen Beiträgen habe ich gesehen, dass auch nur der Vorwiderstand entfernt wurde.&nbsp;</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Den TCRT5000 habe ich am ESP32 an die Pins G14, 5V und GND angeschlossen.</p>
<p><!-- /wp:paragraph --></div>
</div>
<p><!-- /wp:media-text --></p>
<p><!-- wp:heading --></p>
<h2><strong>eHz Elektronischer Haushaltszähler</strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:media-text {"mediaId":1045,"mediaLink":"https://affengriff.net/2022/04/08/esp32-stromzahler-auslesen-webserver/bildschirmfoto-2022-04-08-um-12-13-14/","mediaType":"image","mediaWidth":24} --></p>
<div class="wp-block-media-text alignwide is-stacked-on-mobile" style="grid-template-columns:24% auto">
<figure class="wp-block-media-text__media"><img src="{{ site.baseurl }}/assets/2022/08/Bildschirmfoto-2022-04-08-um-12.13.14-659x1024.png" alt="" class="wp-image-1045 size-full" /></figure>
<div class="wp-block-media-text__content"><!-- wp:paragraph --></p>
<p>Das Gehäuse aus dem 3D Drucker passt beim eHz Elektronischen Haushaltszähler. Mit zwei Magneten wird das Gehäuse am Zähler befestigt da der Stromzähler Eigentum des Netzbetreibers ist!&nbsp;</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Die rechten beiden IR Dioden werden beim IR Lese-Schreibekopf verwendet (<a href="https://www.volkszaehler.org" target="_blank" rel="noreferrer noopener">Volkszähler</a>). Dabei wird permanent zwischen den Unterschiedlichen zur verfügung stehenden Zählerständen geschalten und diese ausgelesen (PIN muss beim jeweiligen Netzbetreiber angefragt werden).</p>
<p><!-- /wp:paragraph --></div>
</div>
<p><!-- /wp:media-text --></p>
<p><!-- wp:heading --></p>
<h2><strong>Zähler Aufsteckmodul ESP32 + TCRT5000</strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:gallery {"linkTo":"none"} --></p>
<figure class="wp-block-gallery has-nested-images columns-default is-cropped"><!-- wp:image {"id":1037,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image size-large"><img src="{{ site.baseurl }}/assets/2022/08/Bildschirmfoto-2022-04-08-um-07.56.57.png" alt="Case<br />
" class="wp-image-1037" /></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:image {"id":1036,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image size-large"><img src="{{ site.baseurl }}/assets/2022/08/Bildschirmfoto-2022-04-08-um-07.57.09.png" alt="ESP32 + TCRT5000" class="wp-image-1036" /></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:image {"id":1038,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image size-large"><img src="{{ site.baseurl }}/assets/2022/08/Bildschirmfoto-2022-04-08-um-07.57.25.png" alt="Case closed" class="wp-image-1038" /></figure>
<p><!-- /wp:image --></figure>
<p><!-- /wp:gallery --></p>
<p><!-- wp:heading --></p>
<h2><strong>Einrichten von Arduino IoT Cloud Remote</strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Nachdem man sich bei Arduino Cloud IoT registriert hat, kann man sich ein neues Projekt mit dem Button "Create" anlegen. Anschließend sind die Felder Devices, Network und Variables auszufüllen. Das Setup von Devices und Network ist eigentlich selbsterklärend, daher werde ich nicht genauer auf diese beiden Punkte eingehen. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3><strong>Variables</strong></h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Durch drücken des Add Button kann man eine Variable hinzufügen. In unserem Fall lautet die Variable "Strom". Als Datentyp verwenden wir einen integer number mit der permission Read only. Bei send value geben wir on change (threshold: 0) an. Das ganze sollte dann so aussehen. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"id":1083,"width":545,"height":216,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image size-large is-resized"><img src="{{ site.baseurl }}/assets/2022/08/Bildschirmfoto-2022-08-01-um-14.41.03-1024x406.png" alt="" class="wp-image-1083" width="545" height="216" /></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p>Die Variable Strom wird im Sketch angegeben und automatisch generiert. Das heißt sie muss im Code nicht extra deklariert werden (kann direkt verwendet werden).</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3><strong>Dashboard</strong></h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Damit wir später an der Handy App das Diagramm zu sehen bekommen müssen wir unter Dashboards ein Chart hinzufügen mit dem Button "Add". Hier muss man nur noch die Verlinkung zwischen Chart und der Variable Strom herstellen (rechts außen). </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"id":1084,"width":347,"height":266,"sizeSlug":"full","linkDestination":"none"} --></p>
<figure class="wp-block-image size-full is-resized"><img src="{{ site.baseurl }}/assets/2022/08/Bildschirmfoto-2022-08-01-um-14.44.48.png" alt="" class="wp-image-1084" width="347" height="266" /></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:heading --></p>
<h2><strong>Code (Sketch)</strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:code {"lineNumbers":true} --></p>
<pre class="wp-block-code"><code lang="c" class="language-c line-numbers">/* 
  Sketch generated by the Arduino IoT Cloud Thing "Untitled"
  https://create.arduino.cc/cloud/things/xxxx-xxxx-xxxx-xxxx 

  Arduino IoT Cloud Variables description

  The following variables are automatically generated and updated when changes are made to the Thing

  int strom;

  Variables which are marked as READ/WRITE in the Cloud Thing will also have functions
  which are called when their values are changed from the Dashboard.
  These functions are generated with the Thing and added at the end of this sketch.
*/

#include "thingProperties.h"
#include &lt;time.h&gt;

/* Configuration of NTP */
#define MY_NTP_SERVER "2.europe.pool.ntp.org"
#define MY_TZ "CET-1CEST,M3.5.0,M10.5.0/3"

/* Globals NTP */
time_t now;
tm tm;

/* Sensor TCRT5000 PIN14 */
const int digital_pin = 14;
int state = 0;
int laststate = 1;
double watt = 0;
unsigned int counter = 0;

/* Update Time for Chart */
int period = 60*1000; // 1min
unsigned long time_now = 0;

/* Reset function after page update */
void resetFunc(){
  counter = 0;
  watt = 0;
}

void setup() {
  // Initialize serial and wait for port to open:
  Serial.begin(9600);
  // This delay gives the chance to wait for a Serial Monitor without blocking if none is found
  delay(1500); 

  // Defined in thingProperties.h
  initProperties();

  // Connect to Arduino IoT Cloud
  ArduinoCloud.begin(ArduinoIoTPreferredConnection);
  
 /*
     The following function allows you to obtain more information
     related to the state of network and IoT Cloud connection and errors
     the higher number the more granular information you’ll get.
     The default is 0 (only errors).
     Maximum is 4
 */
  setDebugMessageLevel(2);
  ArduinoCloud.printDebugInfo();
  
  /* Time NTP */
  configTime(0, 0, MY_NTP_SERVER); 
  setenv("TZ", MY_TZ, 1); // Set your time zone
  tzset();
  
  delay(1000);
}

void loop() {
  ArduinoCloud.update(); 

  // Impulse counter to watt
  state=digitalRead(digital_pin);
  if ( laststate == 1 &amp;&amp; state == 0 )
  {
    counter++;
  }
  laststate = state;

  watt = counter * 6;
  
  if(millis() &gt;= time_now + period){
    time_now += period;
    strom = watt;
    resetFunc();
    Serial.println(strom);
  }
}

/*
  Since Strom is READ_WRITE variable, onStromChange() is
  executed every time a new value is received from IoT Cloud.
*/
void onStromChange()  {
  // Add your code here to act upon Strom change
}</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:heading --></p>
<h2><strong>Handy IoT Remote App</strong></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:image {"id":1082,"width":440,"height":551,"sizeSlug":"full","linkDestination":"none"} --></p>
<figure class="wp-block-image size-full is-resized"><img src="{{ site.baseurl }}/assets/2022/08/IMG_0842.jpg" alt="" class="wp-image-1082" width="440" height="551" /></figure>
<p><!-- /wp:image --></p>
